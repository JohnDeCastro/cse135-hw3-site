<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HW3 â€“ Checkpoint 3 Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --gap: 16px;
      --card-min-h: 360px;
      --chart-h: 260px;
      --radius: 10px;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bg: #0b0c10;
      --panel: #111217;
      --text: #e5e7eb;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: var(--bg);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      margin: 0 0 16px;
      font-size: 22px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: var(--radius);
      margin-bottom: 16px;
    }

    .toolbar label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .toolbar input,
    .toolbar select,
    .toolbar button {
      height: 34px;
      padding: 0 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #0f1116;
      color: var(--text);
    }

    .toolbar button {
      cursor: pointer;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    /* grid: 2 columns on desktop, 1 on mobile */
    .grid {
      display: grid;
      gap: var(--gap);
      grid-template-columns: repeat(2, minmax(0, 1fr));
      align-items: start;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* card */
    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      min-height: var(--card-min-h);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .card h2 {
      margin: 0 0 4px;
      font-size: 16px;
    }

    /* charts */
    .chart {
      position: relative;
      width: 100%;
      height: var(--chart-h);
    }

    .chart canvas {
      position: absolute;
      inset: 0;
      width: 100% !important;
      height: 100% !important;
    }

    /* errors table with internal scroll, sticky header */
    .table-wrap {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: auto;
      flex: 1;
      max-height: calc(var(--card-min-h) - 110px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #0f1116;
      z-index: 1;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      border-bottom: 1px solid var(--border);
      padding: 8px 10px;
    }

    tbody td {
      border-bottom: 1px solid rgba(229, 231, 235, .08);
      padding: 8px 10px;
      font-size: 13px;
    }

    tbody tr:hover {
      background: rgba(229, 231, 235, .04);
    }

    /* link to detailed report */
    .actions {
      margin: 8px 0 16px;
    }

    .actions a {
      color: #93c5fd;
      text-decoration: none;
      border: 1px solid var(--border);
      padding: 6px 10px;
      border-radius: 8px;
      background: #0f1116;
    }

    .actions a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>HW3 â€“ Checkpoint 3 Analytics</h1>

    <div class="actions">
      <a class="btn" href="errors.html">View detailed error report â†’</a>
    </div>

    <div class="toolbar">
      <label>Since:
        <input id="since" type="date" />
      </label>
      <label>Group by:
        <select id="groupBy">
          <option value="day">day</option>
          <option value="hour">hour</option>
        </select>
      </label>
      <button id="refresh">Refresh</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Pageviews</h2>
        <div class="chart"><canvas id="chartPageviews"></canvas></div>
        <div class="muted" id="pvMeta"></div>
      </div>

      <div class="card">
        <h2>Top Routes</h2>
        <div class="chart"><canvas id="chartTopRoutes"></canvas></div>
        <div class="muted" id="trMeta"></div>
      </div>

      <div class="card">
        <h2>Error Rate</h2>
        <div class="chart"><canvas id="chartErrorRate"></canvas></div>
        <div class="muted" id="erMeta"></div>
      </div>

      <div class="card">
        <h2>Recent Errors</h2>
        <div class="table-wrap">
          <table id="tblErrors">
            <thead>
              <tr>
                <th>Endpoint</th>
                <th>Count</th>
                <th>Last seen</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="muted" id="errMeta"></div>
      </div>
    </div>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const fmtDate = s => { try { return new Date(s).toLocaleString(); } catch { return String(s); } };
    const qs = o => new URLSearchParams(o).toString();
    const api = (path, params) => `/api/analytics/${path}?` + qs(params);

    const defaultSince = () => {
      const d = new Date(Date.now() - 7 * 24 * 3600 * 1000);
      return d.toISOString().slice(0, 10);
    };

    $('#since').value = defaultSince();
    $('#groupBy').value = 'day';

    function lineChart(ctx, labels, values, label) {
      if (ctx.chart) ctx.chart.destroy();
      ctx.chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label, data: values, tension: 0.2 }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
      });
      return ctx.chart;
    }
    function barChart(ctx, labels, values, label) {
      if (ctx.chart) ctx.chart.destroy();
      ctx.chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label, data: values }] },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
      });
      return ctx.chart;
    }

    async function loadAll() {
      const since = $('#since').value || defaultSince();
      const groupBy = $('#groupBy').value || 'day';
      $('#status').textContent = 'Loadingâ€¦';
      try {
        const [pv, tr, errs, er] = await Promise.all([
          fetch(api('pageviews', { since, groupBy })).then(r => r.json()),
          fetch(api('top-routes', { since, limit: 10 })).then(r => r.json()),
          fetch(api('errors', { since })).then(r => r.json()),
          fetch(api('error-rate', { since, groupBy: groupBy === 'day' ? 'day' : 'hour' })).then(r => r.json()),
        ]);

        // pageviews
        const pvLabels = (pv.points || []).map(p => p.date ?? fmtDate(p.ts));
        const pvValues = (pv.points || []).map(p => p.count ?? 0);
        lineChart($('#chartPageviews'), pvLabels, pvValues, 'Pageviews');
        $('#pvMeta').textContent = `${pvValues.reduce((a, b) => a + b, 0)} total pageviews`;

        // top Routes
        const routes = (tr.routes || []);
        const trLabels = routes.map(r => r.route || '(unknown)');
        const trValues = routes.map(r => r.hits || 0);
        barChart($('#chartTopRoutes'), trLabels, trValues, 'Hits');
        $('#trMeta').textContent = `${routes.length} routes`;

        // error Rate
        const erLabels = (er.points || []).map(p => fmtDate(p.ts));
        const erValues = (er.points || []).map(p => p.errors || 0);
        lineChart($('#chartErrorRate'), erLabels, erValues, 'Errors per bucket');
        $('#erMeta').textContent = `${erValues.reduce((a, b) => a + b, 0)} errors`;

        // errors table
        const tbody = $('#tblErrors tbody');
        tbody.innerHTML = '';
        const flat = (errs.errors || []);
        if (flat.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 3; td.textContent = 'No recent errors ðŸŽ‰';
          tr.appendChild(td); tbody.appendChild(tr);
        } else {
          for (const row of flat) {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${row.endpoint || '(unknown)'}</td>
              <td>${row.count ?? row.totalErrors ?? 0}</td>
              <td>${row.lastSeen ? fmtDate(row.lastSeen) : 'â€”'}</td>
            `;
            tbody.appendChild(tr);
          }
        }
        $('#errMeta').textContent = `${flat.length} error groups`;
        $('#status').textContent = `Updated ${new Date().toLocaleTimeString()}`;
      } catch (e) {
        console.error(e);
        $('#status').textContent = 'Failed to load (see console)';
        alert('Failed to load analytics. Check console/network and API.');
      }
    }

    $('#refresh').addEventListener('click', loadAll);
    window.addEventListener('load', loadAll);
  </script>
</body>
</html>